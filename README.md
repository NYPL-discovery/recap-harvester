# recap-harvester

This application keeps our databases & search index informed about additions &
updates to, and deletions of, partner bibs and items. It does that by parsing
files that are generated by HTC and posting them to the `BibPostRequest-env` &
`ItemPostRequest-env` streams.

## When does this app run?

This app can be run in 2 different scenarios.

1. The [initial seeding of our databases & index](#initial). (HTC generates a massive zip of our partners' items)
2. On a [nightly basis](#nightly), it downloads HTC-generated files that represent bibliographic additions, updates,
and deletions.

## <a name="nightly"></a> Development & Deployment Instructions for Nightly Updates

TODO: An explanation of the order of operations and an overview
of what this app does on the SFTP server and locally.

### Installing / Building Locally

To compile and run all tests after modifying code:

```
mvn clean package
```

### Running locally

See [.env-local-export.sample](.env-local-export.sample) for a sample config file you can use for running the app locally. To use it, copy `.env-local-export` to `.env-local` and fill in the missing values. This allows you to `source` the file into your shell and run the app:

```
source .env-qa-export; mvn spring-boot:run
```

Note that above also auto-compiles any changes you've made, so there's no need to run `mvn clean package` before running the above.

## <a name="initial"></a> Development & Deployment Instructions for Initial Load

This is for the initial load of data.
TODO: note saying that this requires manual downloading & unzipping from SFTP.

### Installing / Building Locally

#### Environment Variables

The following environment variables need to be set. For different options to set AWS credentials, please refer to http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/credentials.html.

```
AWS_ACCESS_KEY_ID=[used-to-publish-to-kinesis]
AWS_SECRET_ACCESS_KEY=[used-to-publish-to-kinesis]
bibSchemaAPI=https://[domain.example.com]/api/v0.1/current-schemas/BibPostRequest
itemSchemaAPI=https://[domain.example.com]/api/v0.1/current-schemas/ItemPostRequest
kinesisBibStream=[snip]
kinesisItemStream=[snip]
scsbexportstagingLocation=/var/app/current/scsbxml
```

...can we add specific IDE instructions...(or things useful to future maintainers)

### Deploying to Elastic Beanstalk

#### Initial Deploy

1.  `mvn clean package`
1.  `eb init Recap-Harvester --profile [profile name]`
1.  Create application

  ```bash
  eb create [nightly|initial]-recap-harvester-[environment] \
      --instance_type m3.medium \
      --instance_profile [nightly|initial]-cloudwatchable-beanstalk \
      --cname recap-harvester-[environment] \
      --single \
      --vpc.id env-vpc \
      --vpc.ec2subnets private-subnet-id-1 \
      --tags Project=Discovery,harvester=recap_harvester \
      --keyname dgdvteam \
      --envvars KEYFROMABOVE="value",KEYFROMABOVE2="value" \
      --profile your-aws-profile-name
  ```
